<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced AI Calculator (PWA)</title>
  <meta name="theme-color" content="#FFFFFF"/>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">
  <link rel="manifest" href="manifest.json">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Cairo:wght@400;700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
  
  <script type="importmap">
  {
    "imports": {
      "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
      "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
      "react/": "https://aistudiocdn.com/react@^19.2.0/",
      "react": "https://aistudiocdn.com/react@^19.2.0",
      "@google/genai": "https://esm.run/@google/genai"
    }
  }
  </script>

  <style>
    html {
      font-size: calc(16px * var(--font-scale, 1));
    }
    :root {
      /* --- Light Theme --- */
      --bg-primary-gradient: linear-gradient(135deg, #F0F4F8, #D9E2EC);
      --bg-calculator: rgba(255, 255, 255, 0.75);
      --bg-display: #EDF2F7;
      --bg-header: rgba(237, 242, 247, 0.6);
      --bg-panel: rgba(255, 255, 255, 0.94);
      --text-primary: #1A202C;
      --text-secondary: #4A5568;
      --text-display: #1A202C;
      --border-primary: rgba(0, 0, 0, 0.1);
      --border-secondary: rgba(0, 0, 0, 0.08);
      --button-border-color: rgba(0, 0, 0, 0.1);
      --button-number-bg: linear-gradient(145deg, #E2E8F0, #FFFFFF);
      --button-function-bg: linear-gradient(145deg, #CBD5E0, #E2E8F0);
      --button-number-shadow: 0 4px 8px rgba(0,0,0,0.08);
      --button-number-active-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      --bg-inset: rgba(0, 0, 0, 0.05);
      --bg-inset-light: rgba(0, 0, 0, 0.03);
      --calculator-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --accent-color: #2B6CB0;
      --accent-color-contrast: #FFFFFF;
      --accent-equals-bg: linear-gradient(145deg, #38A169, #2F855A);
      --accent-equals-text: #FFFFFF;
      --accent-equals-shadow: 0 4px 6px -1px rgb(46 125 50 / 0.2), 0 2px 4px -2px rgb(46 125 50 / 0.2);
      --accent-equals-active-shadow: 0 1px 2px 0 rgb(46 125 50 / 0.3);
      --accent-equals-pulse-shadow: 0 10px 15px -3px rgb(46 125 50 / 0.2), 0 4px 6px -4px rgb(46 125 50 / 0.2);
      --display-text-shadow: none;
    }
    .dark {
      /* --- Dark Theme --- */
      --bg-primary-gradient: linear-gradient(135deg, #0a0e17, #131827);
      --bg-calculator: rgba(15, 25, 45, 0.85);
      --bg-display: rgba(10, 20, 40, 0.92);
      --bg-header: rgba(20, 35, 70, 0.6);
      --bg-panel: rgba(20, 35, 70, 0.94);
      --text-primary: #e3f2fd;
      --text-secondary: #bbdefb;
      --text-display: white;
      --border-primary: rgba(80, 150, 255, 0.4);
      --border-secondary: rgba(100, 180, 255, 0.3);
      --button-border-color: rgba(80, 150, 255, 0.35);
      --button-number-bg: linear-gradient(145deg, rgba(30, 50, 85, 0.7), rgba(40, 65, 100, 0.8));
      --button-function-bg: linear-gradient(145deg, rgba(30, 55, 100, 0.8), rgba(45, 75, 120, 0.9));
      --button-number-shadow: inset 0 -3px 7px rgba(0, 15, 40, 0.75), 0 3px 8px rgba(0, 10, 30, 0.4);
      --button-number-active-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.65), 0 1px 4px rgba(0, 0, 0, 0.35);
      --bg-inset: rgba(20, 35, 70, 0.6);
      --bg-inset-light: rgba(30, 50, 90, 0.5);
      --calculator-shadow: 0 0 40px rgba(60, 120, 255, 0.5), 0 25px 60px rgba(0, 0, 0, 0.6);
      --accent-color: #4fc3f7;
      --accent-color-contrast: #000000;
      --display-text-shadow: 0 0 14px rgba(100, 180, 255, 0.6);
    }
    
    body {
      font-family: var(--font-family, 'Tajawal', sans-serif);
      background: var(--bg-primary-gradient);
      color: var(--text-primary);
      transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
    }

    /* For custom scrollbar styling to match the theme */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-panel); }
    ::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; border: 2px solid var(--bg-panel); }
    * { scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--bg-panel); }

    /* Animations */
    @keyframes fade-in-down { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fade-in-down 0.5s ease-out forwards; }
    @keyframes pulse-special { 0%, 100% { transform: scale(1); box-shadow: var(--accent-equals-shadow); } 50% { transform: scale(1.05); box-shadow: var(--accent-equals-pulse-shadow); } }
    .animate-pulse-special { animation: pulse-special 2s infinite ease-in-out; }
    @keyframes container-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-container-in { animation: container-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    @keyframes pop-in { from { transform: translateY(10px) scale(0.98); opacity: 0.6; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .animate-pop-in { animation: pop-in 0.3s ease-out forwards; }
    @keyframes bounce-in-up { 0% { opacity: 0; transform: translateY(30px) scale(0.9); } 50% { opacity: 1; transform: translateY(-10px) scale(1.05); } 100% { transform: translateY(0) scale(1); } }
    .animate-bounce-in-up { animation: bounce-in-up 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }

    .error-highlight {
      font-weight: bold;
    }
    .ai-suggestion-highlight {
      text-decoration: underline;
      text-decoration-style: dotted;
      text-decoration-color: var(--accent-color);
      text-underline-offset: 4px;
      text-decoration-thickness: 2px;
    }
    
    /* Utility to hide scrollbar */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

</head>
<body>
  <div id="root"></div>
  
  <script type="module">
    // --- Library Imports ---
    import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
    import ReactDOM from 'react-dom/client';
    import { GoogleGenAI, Type } from '@google/genai';

    // --- Inlined: services/calculationEngine.ts ---
    function parseExpression(expr) {
        if (!expr) return 0;
        expr = expr.replace(/(?<=^|[-+*/(])-/g, 'N');
        const tokens = [];
        let i = 0;
        while (i < expr.length) {
            const char = expr[i];
            if (/\d/.test(char) || (char === '.')) {
                let numStr = '';
                while (i < expr.length && /[\d.]/.test(expr[i])) {
                    numStr += expr[i];
                    i++;
                }
                if ((numStr.match(/\./g) || []).length > 1) throw new Error('ŸÜŸÇÿ∑ÿ© ÿπÿ¥ÿ±Ÿäÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©');
                tokens.push(parseFloat(numStr));
            } else if (char === 'N') {
                tokens.push('N');
                i++;
            } else if (['(', ')', '+', '-', '*', '/'].includes(char)) {
                if (char === '(' && i + 1 < expr.length && expr[i+1] === ')') {
                  throw new Error('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                }
                tokens.push(char);
                i++;
            } else {
                throw new Error('ÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ');
            }
        }
        if (tokens.length === 0) return 0;
        const output = [];
        const operators = [];
        const precedence = { '+': 1, '-': 1, '*': 2, '/': 2, 'N': 3 };
        const isOperator = (t) => ['+', '-', '*', '/', 'N'].includes(t);
        for (const token of tokens) {
            if (typeof token === 'number') {
                output.push(token);
            } else if (token === '(') {
                operators.push(token);
            } else if (token === ')') {
                while (operators.length > 0 && operators[operators.length - 1] !== '(') {
                    output.push(operators.pop());
                }
                if (operators.length === 0) throw new Error('ÿ£ŸÇŸàÿßÿ≥ ÿ∫Ÿäÿ± ŸÖÿ™Ÿàÿßÿ≤ŸÜÿ©');
                operators.pop();
            } else if (isOperator(token)) {
                while (operators.length > 0 && operators[operators.length - 1] !== '(' && precedence[operators[operators.length - 1]] >= precedence[token]) {
                    output.push(operators.pop());
                }
                operators.push(token);
            }
        }
        while (operators.length > 0) {
            const op = operators.pop();
            if (op === '(') throw new Error('ÿ£ŸÇŸàÿßÿ≥ ÿ∫Ÿäÿ± ŸÖÿ™Ÿàÿßÿ≤ŸÜÿ©');
            output.push(op);
        }
        const stack = [];
        for (const token of output) {
            if (typeof token === 'number') {
                stack.push(token);
            } else if (isOperator(token)) {
                if (token === 'N') {
                    if (stack.length < 1) throw new Error('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                    stack.push(-stack.pop());
                    continue;
                }
                if (stack.length < 2) throw new Error('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                const b = stack.pop();
                const a = stack.pop();
                let result;
                switch (token) {
                    case '+': result = a + b; break;
                    case '-': result = a - b; break;
                    case '*': result = a * b; break;
                    case '/':
                        if (b === 0) throw new Error('ÿßŸÑŸÇÿ≥ŸÖÿ© ÿπŸÑŸâ ÿµŸÅÿ±');
                        result = a / b;
                        break;
                    default: throw new Error('ÿπÿßŸÖŸÑ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ');
                }
                stack.push(result);
            }
        }
        if (stack.length !== 1) throw new Error('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
        return stack[0];
    }


    // --- Inlined: services/geminiService.ts ---
    async function getAiFix(expression, errorMessage) {
      if (!process.env.API_KEY) {
        console.log("API_KEY environment variable not set. Skipping Gemini call.");
        return null;
      }
      try {
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        const prompt = `Correct the following mathematical expression which caused an error.
Provide a brief, one-sentence explanation in Arabic about the error.
Expression: "${expression}"
Error: "${errorMessage}"
Respond ONLY with a valid JSON object with two keys: "fix" (the corrected expression) and "message" (the explanation in Arabic).`;

        const response = await ai.models.generateContent({
          model: 'gemini-2.5-flash',
          contents: prompt,
          config: {
            responseMimeType: 'application/json',
            responseSchema: {
              type: Type.OBJECT,
              properties: {
                fix: { type: Type.STRING },
                message: { type: Type.STRING }
              },
              required: ['fix', 'message']
            }
          }
        });

        const jsonString = response.text.trim();
        const result = JSON.parse(jsonString);

        if (result.fix && result.message) {
          return { fix: result.fix, message: `üí° ${result.message}` };
        }
        return null;
      } catch (error) {
        console.error("Gemini API Error:", error);
        return null;
      }
    }


    // --- Inlined: services/localErrorFixer.ts ---
    function getLocalFix(expression) {
        let fixedExpr = expression;
        
        // Rule 1: Fix duplicate operators (e.g., 5++3 -> 5+3)
        fixedExpr = fixedExpr.replace(/([+\-√ó√∑])\1+/g, '$1');
        if (fixedExpr !== expression) {
            return { fix: fixedExpr, message: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿπÿßŸÖŸÑ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÉÿ±ÿ±.' };
        }
        
        // Rule 2: Handle empty parentheses (e.g., 6*() -> 6)
        if (fixedExpr.includes('()')) {
            fixedExpr = fixedExpr.replace(/([+\-√ó√∑]?)\(\)/g, '');
            return { fix: fixedExpr || '0', message: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ£ŸÇŸàÿßÿ≥ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©.' };
        }

        // Rule 3: Fix trailing operator (e.g., 5+ -> 5)
        if (/[+\-√ó√∑]$/.test(fixedExpr.trim())) {
            fixedExpr = fixedExpr.trim().slice(0, -1);
            return { fix: fixedExpr, message: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿπÿßŸÖŸÑ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸÅŸä ÿßŸÑŸÜŸáÿßŸäÿ©.' };
        }
        
        // Rule 4: Mismatched parentheses (e.g., (9-2 -> (9-2))
        const openParenCount = (fixedExpr.match(/\(/g) || []).length;
        const closeParenCount = (fixedExpr.match(/\)/g) || []).length;
        if (openParenCount > closeParenCount) {
            fixedExpr += ')'.repeat(openParenCount - closeParenCount);
            return { fix: fixedExpr, message: 'ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÇŸàÿ≥ ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸÅŸÇŸàÿØ.' };
        }

        // Generic fallback
        return { message: 'ÿßŸÑÿ™ÿπÿ®Ÿäÿ± Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿÆÿ∑ÿ£.', fix: '' };
    }

    function findErrorDetails(expression, message) {
        if (message.includes('ÿ£ŸÇŸàÿßÿ≥ ÿ∫Ÿäÿ± ŸÖÿ™Ÿàÿßÿ≤ŸÜÿ©')) {
            let balance = 0;
            for (let i = 0; i < expression.length; i++) {
                if (expression[i] === '(') balance++;
                if (expression[i] === ')') balance--;
            }
            if (balance > 0) { // Unclosed open parenthesis
                let openParenIndex = expression.lastIndexOf('(');
                 let tempBalance = 0;
                 for (let i = openParenIndex; i < expression.length; i++) {
                     if (expression[i] === '(') tempBalance++;
                     if (expression[i] === ')') tempBalance--;
                 }
                 if (tempBalance > 0) {
                      return {
                        pre: expression.substring(0, openParenIndex),
                        highlight: expression[openParenIndex],
                        post: expression.substring(openParenIndex + 1)
                      };
                 }
            }
        }
        if (message.includes('ÿßŸÑŸÇÿ≥ŸÖÿ© ÿπŸÑŸâ ÿµŸÅÿ±')) {
            const match = expression.match(/√∑0(?!\.)/); // find √∑0 but not √∑0.5
            if (match && typeof match.index === 'number') {
                return {
                    pre: expression.substring(0, match.index),
                    highlight: '√∑0',
                    post: expression.substring(match.index + 2)
                };
            }
        }
        if (message.includes('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠')) {
            const match = expression.match(/\(\)/);
            if (match && typeof match.index === 'number') {
                return {
                    pre: expression.substring(0, match.index),
                    highlight: '()',
                    post: expression.substring(match.index + 2)
                };
            }
        }
        // Fallback: no specific highlight
        return null;
    }


    // --- Inlined: hooks/useCalculator.ts ---
    const defaultButtonLayout = [
      { id: 'ac', label: 'AC', action: 'clear', type: 'function' },
      { id: 'backspace', label: '‚Üê', action: 'backspace', type: 'function' },
      { id: 'ans', label: 'Ans', action: 'appendAnswer', type: 'function' },
      { id: 'percent', label: '%', value: '%', type: 'function' },
      { id: 'divide', label: '√∑', value: '√∑', type: 'operator' },
      { id: '7', label: '7', value: '7', type: 'number' },
      { id: '8', label: '8', value: '8', type: 'number' },
      { id: '9', label: '9', value: '9', type: 'number' },
      { id: 'sign', label: '¬±', action: 'toggleSign', type: 'function' },
      { id: 'multiply', label: '√ó', value: '√ó', type: 'operator' },
      { id: '4', label: '4', value: '4', type: 'number' },
      { id: '5', label: '5', value: '5', type: 'number' },
      { id: '6', label: '6', value: '6', type: 'number' },
      { id: 'paren', label: '( )', action: 'parenthesis', type: 'operator' },
      { id: 'subtract', label: '-', value: '-', type: 'operator' },
      { id: '1', label: '1', value: '1', type: 'number' },
      { id: '2', label: '2', value: '2', type: 'number' },
      { id: '3', label: '3', value: '3', type: 'number' },
      { id: 'decimal', label: '.', value: '.', type: 'number' },
      { id: 'add', label: '+', value: '+', type: 'operator' },
      { id: '0', label: '0', value: '0', type: 'number' },
      { id: '00', label: '00', value: '00', type: 'number' },
      { id: '000', label: '000', value: '000', type: 'number' },
      { id: 'equals', label: '=', action: 'calculate', type: 'equals', span: 2 },
    ];
    const useLocalStorage = (key, initialValue) => {
      const [storedValue, setStoredValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          const parsed = item ? JSON.parse(item) : initialValue;
          // Migration for history items to add id and notes
          if (key === 'calcHistory_v2' && Array.isArray(parsed) && parsed.length > 0 && !parsed[0].id) {
              const migrated = parsed.map((histItem, index) => ({
                  ...histItem,
                  id: Date.now() - index,
                  notes: '',
              }));
              window.localStorage.setItem(key, JSON.stringify(migrated));
              return migrated;
          }
          return parsed;
        } catch (error) {
          console.error(error);
          return initialValue;
        }
      });
      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
          console.error(error);
        }
      };
      return [storedValue, setValue];
    };
    const useCalculator = ({ showNotification }) => {
      const [input, setInput] = useState('0');
      const [history, setHistory] = useLocalStorage('calcHistory_v2', []);
      const [lastAnswer, setLastAnswer] = useLocalStorage('calcLastAnswer', '0');
      const [vibrationEnabled, setVibrationEnabled] = useLocalStorage('calcVibration', true);
      const [taxSettings, setTaxSettings] = useLocalStorage('calcTaxSettings_v2', { isEnabled: false, mode: 'add-15', rate: 15, showTaxPerNumber: false });
      const [maxHistory, setMaxHistory] = useLocalStorage('calcMaxHistory', 50);
      const [buttonLayout, setButtonLayout] = useLocalStorage('calcButtonLayout_v8', defaultButtonLayout);
      const [calculationExecuted, setCalculationExecuted] = useState(false);
      const [error, setError] = useState(null); // Can be { message: string, details: object | null }
      const [aiSuggestion, setAiSuggestion] = useState(null);

      const entryCount = useMemo(() => {
          if (calculationExecuted) return 1;
          if (input === '0' || !input) return 0;
          const numbers = input.match(/\d+(\.\d+)?/g);
          return numbers ? numbers.length : 0;
      }, [input, calculationExecuted]);
      
      useEffect(() => {
        const validModes = ['add-15', 'divide-93', 'custom', 'extract-custom'];
        if (taxSettings.isEnabled && !validModes.includes(taxSettings.mode)) {
          setTaxSettings(prev => ({...prev, mode: 'add-15'}));
        }
      }, [taxSettings, setTaxSettings]);

      const vibrate = (duration = 30) => {
        if (vibrationEnabled && navigator.vibrate) {
          navigator.vibrate(duration);
        }
      };
      const clearAll = useCallback(() => {
        vibrate(50);
        setInput('0');
        setCalculationExecuted(false);
        setError(null);
        setAiSuggestion(null);
      }, [vibrationEnabled]);
      const backspace = useCallback(() => {
        vibrate(30);
        setError(null);
        setAiSuggestion(null);
        setInput(prev => {
          const newStr = prev.slice(0, -1);
          return newStr === '' || newStr === '0' ? '0' : newStr;
        });
        setCalculationExecuted(false);
      }, [vibrationEnabled]);
      const append = useCallback((value) => {
        vibrate(20);
        setError(null);
        setAiSuggestion(null);
        if (calculationExecuted) {
          const isOperator = ['+', '-', '√ó', '√∑'].includes(value);
          setInput(isOperator ? input + value : value);
          setCalculationExecuted(false);
          return;
        }
        setInput(prev => {
          if (prev === '0' && !['.', '(', ')'].includes(value)) return value;
          
          const lastChar = prev.slice(-1);
          // Automatically add multiplication sign after a closing parenthesis if a number/decimal is entered.
          if (lastChar === ')' && !['+', '-', '√ó', '√∑', '%', ')'].includes(value)) {
              return prev + '√ó' + value;
          }

          if (['+', '√ó', '√∑'].includes(value) && ['+', '√ó', '√∑', '-'].includes(prev.slice(-1))) {
            return prev.slice(0, -1) + value;
          }
          return prev + value;
        });
      }, [calculationExecuted, input, vibrationEnabled]);
       const toggleSign = useCallback(() => {
        vibrate(30);
        const isSimpleNumber = /^-?\d+(\.\d+)?$/.test(input);
        if (calculationExecuted || isSimpleNumber) {
            setInput(prev => {
                if (prev === '0') return '0';
                const new_input = prev.startsWith('-') ? prev.slice(1) : '-' + prev;
                setCalculationExecuted(false);
                return new_input;
            });
        }
      }, [vibrationEnabled, calculationExecuted, input]);
      const handleParenthesis = useCallback(() => {
        vibrate(20);
        setError(null);
        setAiSuggestion(null);

        if (calculationExecuted) {
            setInput('(');
            setCalculationExecuted(false);
            return;
        }

        setInput(prev => {
            const openParenCount = (prev.match(/\(/g) || []).length;
            const closeParenCount = (prev.match(/\)/g) || []).length;
            const lastChar = prev.slice(-1);
            if (openParenCount > closeParenCount && !['(', '+', '-', '√ó', '√∑'].includes(lastChar)) {
                return prev + ')';
            } else {
                if (prev === '0') return '(';
                if (!isNaN(parseInt(lastChar, 10)) || lastChar === ')') {
                    return prev + '√ó(';
                }
                return prev + '(';
            }
        });
      }, [calculationExecuted, vibrationEnabled]);
       const appendAnswer = useCallback(() => {
        vibrate(20);
        setError(null);
        setAiSuggestion(null);
        
        if (calculationExecuted) {
            setInput(lastAnswer);
            setCalculationExecuted(false);
            return;
        }
        
        setInput(prev => {
            if (prev === '0') return lastAnswer;
            const lastChar = prev.slice(-1);
             if (!isNaN(parseInt(lastChar, 10)) || lastChar === ')') {
                return prev + '√ó' + lastAnswer;
            }
            return prev + lastAnswer;
        });
      }, [lastAnswer, calculationExecuted, vibrationEnabled]);
      const calculate = useCallback(async () => {
        vibrate(70);
        setError(null);
        setAiSuggestion(null);
        const expression = input;
        if (expression === '0') return;
        try {
          const safeExpr = expression.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/%/g, '/100').replace(/(?<=^|\()(\+)/g, '');
          let result = parseExpression(safeExpr);
          if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
            throw new Error('ÿ™ÿπÿ®Ÿäÿ± ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ±Ÿäÿßÿ∂ŸäŸãÿß.');
          }
          const resultStr = result.toLocaleString('en-US', {maximumFractionDigits: 10, useGrouping: false});
          setLastAnswer(resultStr);
          const now = new Date();
          
          let taxResultValue = null;
          let effectiveTaxRate = parseFloat(taxSettings.rate) || 0;
          
          if (taxSettings.isEnabled) {
              switch(taxSettings.mode) {
                  case 'add-15':
                      taxResultValue = result * (1 + 15 / 100);
                      effectiveTaxRate = 15;
                      break;
                  case 'custom':
                      taxResultValue = result * (1 + effectiveTaxRate / 100);
                      break;
                  case 'extract-custom':
                      taxResultValue = result / (1 + effectiveTaxRate / 100);
                      break;
                  case 'divide-93':
                      taxResultValue = result / 0.93;
                      break;
              }
          }

          const taxResult = taxResultValue ? taxResultValue.toLocaleString('en-US', {maximumFractionDigits: 10, useGrouping: false}) : null;
          const taxLabel = taxSettings.mode === 'extract-custom' ? 'ÿßŸÑÿ£ÿµŸÑ ÿ®ÿØŸàŸÜ ÿ∂ÿ±Ÿäÿ®ÿ©' : 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©';
          
          const newItem = {
            id: Date.now(),
            expression: expression,
            result: resultStr,
            taxResult: taxResult,
            taxMode: taxSettings.isEnabled ? taxSettings.mode : null,
            taxRate: taxSettings.isEnabled ? effectiveTaxRate : null,
            taxLabel: taxSettings.isEnabled ? taxLabel : null,
            date: now.toLocaleDateString('ar-EG', { year: 'numeric', month: '2-digit', day: '2-digit' }),
            time: now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
            notes: ''
          };
          setHistory([newItem, ...history].slice(0, maxHistory));
          setInput(resultStr);
          setCalculationExecuted(true);
        } catch (e) {
            const errorMessage = e.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
            setError({ message: errorMessage, details: findErrorDetails(expression, errorMessage) });
            setCalculationExecuted(false);
            setAiSuggestion({ message: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≠ŸÑ ÿ∞ŸÉŸä...', fix: null, isLoading: true });

            const geminiFix = await getAiFix(expression, errorMessage);
            if (geminiFix && geminiFix.fix) {
                setAiSuggestion({ ...geminiFix, isLoading: false });
            } else {
                const localFix = getLocalFix(expression);
                if (localFix && localFix.fix) {
                    setAiSuggestion({ ...localFix, isLoading: false });
                } else {
                    setAiSuggestion(null); // No fix found, clear loading state
                }
            }
        }
      }, [input, taxSettings, history, setHistory, vibrationEnabled, maxHistory, setLastAnswer]);
      const applyAiFix = useCallback(() => {
        if (aiSuggestion?.fix) {
            setInput(aiSuggestion.fix);
            setError(null);
            setAiSuggestion(null);
        }
      }, [aiSuggestion]);
      const clearHistory = useCallback(() => {
        vibrate(50);
        setHistory([]);
      }, [setHistory, vibrationEnabled]);
      const deleteHistoryItem = useCallback((id) => {
        setHistory(prevHistory => prevHistory.filter(item => item.id !== id));
      }, [setHistory]);
      const loadFromHistory = useCallback((expression) => {
        setInput(expression);
        setCalculationExecuted(false);
        setError(null);
        setAiSuggestion(null);
      }, []);
      const updateInput = useCallback((value) => {
        setError(null);
        setAiSuggestion(null);
        if (calculationExecuted) {
            setCalculationExecuted(false);
        }
        setInput(value === '' ? '0' : value);
      }, [calculationExecuted]);
      const updateHistoryItemNote = useCallback((id, note) => {
          setHistory(prevHistory => 
              prevHistory.map(item =>
                  item.id === id ? { ...item, notes: note } : item
              )
          );
      }, [setHistory]);
      
      return {
        input, history, error, aiSuggestion, isCalculationExecuted: calculationExecuted, entryCount,
        settings: {
          vibrationEnabled, setVibrationEnabled,
          taxSettings, setTaxSettings, maxHistory, setMaxHistory, buttonLayout
        },
        actions: {
          append, clearAll, backspace, calculate, toggleSign, handleParenthesis, appendAnswer, applyAiFix, clearHistory, deleteHistoryItem, loadFromHistory, updateInput, updateHistoryItemNote
        }
      };
    };

    // --- Inlined: components/Button.tsx ---
    const Button = ({ children, onClick, className = '', style = {} }) => {
      return (
        React.createElement('button', {
          onClick: onClick,
          style: style,
          className: `border border-[var(--button-border-color)] py-4 text-2xl rounded-2xl cursor-pointer transition-all duration-100 text-center select-none shadow-[var(--button-number-shadow)] active:transform active:scale-[0.95] active:shadow-[var(--button-number-active-shadow)] active:brightness-95 ${className}`,
        }, React.createElement('span', { style: { textShadow: 'var(--button-text-shadow, none)' } }, children))
      );
    };


    // --- Inlined: components/Overlay.tsx ---
    const Overlay = ({ show, onClick, zIndex = 'z-40' }) => {
      return (
        React.createElement('div', {
          onClick: onClick,
          className: `fixed inset-0 bg-black/70 transition-opacity duration-300 ${show ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'} ${zIndex}`
        })
      );
    };


    // --- Inlined: components/Notification.tsx ---
    const Notification = ({ message, show }) => {
      return (
        React.createElement('div', {
          className: `fixed left-1/2 -translate-x-1/2 bottom-5 bg-green-600/95 text-white py-3 px-6 rounded-full z-[100] shadow-lg text-base text-center transition-opacity duration-300 ${show ? 'opacity-100 animate-bounce-in-up' : 'opacity-0 pointer-events-none'}`
        }, message)
      );
    };


    // --- Inlined: components/Header.tsx ---
    const Header = ({ taxSettings, onToggleSettings, onShare, onToggleHistory, historyCount, entryCountDisplay }) => {
      const { isEnabled, rate, mode } = taxSettings;
      const getTaxRateLabel = () => {
        if (!isEnabled) return '---';
        const displayRate = parseFloat(rate) || 0;
        switch (mode) {
          case 'add-15': return '+15%';
          case 'divide-93': return 'ŸÖŸÇÿ≥ŸàŸÖ ÿπŸÑŸâ 0.93';
          case 'custom': return `+${displayRate}%`;
          case 'extract-custom': return `-${displayRate}%`;
          default: return `${displayRate}%`;
        }
      };
      return (
        React.createElement('div', { className: "flex justify-between items-center p-2.5 rounded-2xl mb-4 bg-[var(--bg-header)] border border-[var(--border-primary)] backdrop-blur-sm" },
          React.createElement(Button, { onClick: onShare, className: "!p-1.5 !text-lg !min-w-[45px] !rounded-xl bg-[var(--bg-inset)] !text-[var(--text-secondary)]" }, "üì§"),
          
          React.createElement('div', { className: "flex items-center gap-2" },
            React.createElement('div', { className: `text-sm py-1 px-2.5 rounded-xl bg-[var(--bg-inset)] text-[var(--text-secondary)] whitespace-nowrap transition-opacity duration-300 ${isEnabled ? 'opacity-100' : 'opacity-60'}` },
              "ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©: ", React.createElement('span', { className: "font-bold text-[var(--text-primary)]" }, getTaxRateLabel())
            ),
             React.createElement('div', { className: "text-sm py-1 px-2.5 rounded-xl bg-[var(--bg-inset)] text-[var(--text-secondary)] whitespace-nowrap" },
              "ÿßŸÑÿ•ÿØÿÆÿßŸÑÿßÿ™: ", React.createElement('span', { className: "font-bold text-[var(--text-primary)]" }, entryCountDisplay)
            )
          ),

          React.createElement('div', { className: "flex items-center gap-2" },
            React.createElement('div', { className: "relative" },
              React.createElement(Button, { onClick: onToggleHistory, className: "!p-1.5 !text-lg !min-w-[45px] !rounded-xl bg-[var(--bg-inset)] text-[var(--text-secondary)]" }, "üìú"),
              historyCount > 0 && React.createElement('span', { className: "absolute -top-1 -right-1.5 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center pointer-events-none" }, historyCount > 99 ? '99+' : historyCount)
            ),
            React.createElement(Button, { onClick: onToggleSettings, className: "!p-1.5 !text-lg !min-w-[45px] !rounded-xl bg-[var(--bg-inset)] text-[var(--text-primary)]" }, "‚öôÔ∏è")
          )
        )
      );
    };


    // --- Inlined: components/Display.tsx ---
    const calculateTaxForNumber = (numStr, settings) => {
        const num = parseFloat(numStr);
        if (isNaN(num)) return '';
        let taxValue = 0;
        const { mode, rate } = settings;
        switch(mode) {
            case 'add-15': taxValue = num * 0.15; break;
            case 'custom': taxValue = num * (parseFloat(rate) / 100); break;
            case 'divide-93': taxValue = (num / 0.93) - num; break;
            default: return '';
        }
        return taxValue.toLocaleString('en-US', { maximumFractionDigits: 2, useGrouping: false });
    };
    const renderPreviewWithTax = (text, settings) => {
      if (!settings.isEnabled || !settings.showTaxPerNumber || !text) return text;
      const parts = text.split(/([0-9.]+)/g);
      return (
        React.createElement(React.Fragment, null,
          parts.map((part, index) => {
            if (/[0-9.]+/.test(part) && !isNaN(parseFloat(part))) {
              const tax = calculateTaxForNumber(part, settings);
              return (
                React.createElement('span', { key: index, className: "relative inline-block mx-px pt-5" },
                  React.createElement('span', { className: "absolute top-0 left-1/2 -translate-x-1/2 text-xs text-yellow-400 bg-gray-900/60 px-1.5 py-0.5 rounded whitespace-nowrap" },
                    tax
                  ),
                  part
                )
              );
            }
            return React.createElement('span', { key: index }, part);
          })
        )
      );
    };
    const Display = ({ input, taxSettings, error, aiSuggestion, onApplyAiFix, isCalculationExecuted, onUpdateInput }) => {
      const [isEditing, setIsEditing] = useState(false);
      const textareaRef = useRef(null);
      useEffect(() => {
        if (isEditing && textareaRef.current) {
          const el = textareaRef.current;
          el.focus();
          el.style.height = 'auto';
          el.style.height = `${el.scrollHeight}px`;
          el.setSelectionRange(el.value.length, el.value.length);
        }
      }, [isEditing]);
      useEffect(() => {
        if (isEditing && textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
        }
      }, [input, isEditing]);
      let liveResult = '0';
      let taxAmount = '';
      let totalWithTax = '';
      let preview = isCalculationExecuted ? '' : input;
      
      if (error) {
        liveResult = '...';
      } else if (isCalculationExecuted) {
        liveResult = input;
        preview = '';
      } else {
        try {
          const safeExpr = input.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/%/g, '/100').replace(/(?<=^|\()(\+)/g, '');
          const result = parseExpression(safeExpr);
          if (!isNaN(result) && isFinite(result)) {
            liveResult = result.toLocaleString('en-US', {maximumFractionDigits: 10, useGrouping: false});
          }
        } catch (e) {
          liveResult = '...';
        }
      }
      
      if (taxSettings.isEnabled && !isNaN(parseFloat(liveResult))) {
          const numResult = parseFloat(liveResult);
          let taxValue = 0;
          let secondaryValue = 0;
          let secondaryLabel = 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä';
          const { mode, rate } = taxSettings;
          const effectiveRate = parseFloat(rate) || 0;

          switch(mode) {
              case 'add-15':
                  taxValue = numResult * 0.15;
                  secondaryValue = numResult + taxValue;
                  break;
              case 'custom':
                  taxValue = numResult * (effectiveRate / 100);
                  secondaryValue = numResult + taxValue;
                  break;
              case 'extract-custom':
                  secondaryValue = numResult / (1 + (effectiveRate / 100));
                  taxValue = numResult - secondaryValue;
                  secondaryLabel = 'ÿßŸÑÿ£ÿµŸÑ';
                  break;
              case 'divide-93':
                  secondaryValue = numResult / 0.93;
                  taxValue = secondaryValue - numResult;
                  break;
          }
          const taxLabel = 'ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©';
          taxAmount = `${taxLabel}: ${taxValue.toLocaleString('en-US', {maximumFractionDigits: 2, useGrouping: false})}`;
          totalWithTax = `${secondaryLabel}: ${secondaryValue.toLocaleString('en-US', {maximumFractionDigits: 2, useGrouping: false})}`;
      }

      const displayBorderClass = error || aiSuggestion ? 'bg-gradient-to-r from-red-600 via-orange-500 to-red-600 shadow-[0_0_20px_rgba(255,61,0,0.7)]' : '';
      
      const renderHighlightedExpression = () => {
        let content;
        if (error?.details) {
            const { pre, highlight, post } = error.details;
            content = React.createElement(React.Fragment, null, 
                pre, 
                React.createElement('span', { className: 'text-red-500 bg-red-500/20 rounded-md px-1 error-highlight' }, highlight), 
                post
            );
        } else if (taxSettings.showTaxPerNumber) {
            content = renderPreviewWithTax(preview, taxSettings);
        } else {
            content = preview || ' ';
        }

        if (aiSuggestion?.fix) {
            return React.createElement('span', { className: 'ai-suggestion-highlight' }, content);
        }
        
        return content;
      };
      
      return (
        React.createElement('div', { className: "relative p-4 bg-[var(--bg-display)] rounded-[25px] mb-4 border border-[var(--border-primary)] shadow-[inset_0_4px_10px_rgba(0,0,0,0.08)] min-h-[220px] flex flex-col justify-between" },
          React.createElement('div', { className: `absolute inset-0 -z-10 rounded-[22px] transition-all duration-300 ${displayBorderClass}` }),
          React.createElement('div', { className: "px-1.5 flex flex-col justify-end flex-grow" },
            React.createElement('div', { className: "text-xl text-[var(--text-secondary)] mb-1 text-left direction-ltr break-all min-h-[30px]", onClick: () => !isCalculationExecuted && setIsEditing(true) },
                isEditing ? (
                     React.createElement('textarea', {
                        ref: textareaRef,
                        value: preview,
                        onChange: (e) => onUpdateInput(e.target.value),
                        onBlur: () => setIsEditing(false),
                        className: "w-full bg-transparent border-none outline-none resize-none text-xl opacity-70 text-left direction-ltr p-0 m-0 leading-normal text-[var(--text-display)]",
                        rows: 1
                    })
                ) : (
                    renderHighlightedExpression()
                )
            ),
            React.createElement('div', { key: liveResult, className: "text-6xl mt-auto font-bold text-center direction-ltr overflow-x-auto whitespace-nowrap text-[var(--text-display)] scrollbar-hide leading-tight", style: { textShadow: 'var(--display-text-shadow, none)' } },
              React.createElement('span', { className: "inline-block animate-pop-in" }, liveResult)
            )
          ),
          React.createElement('div', { className: "relative h-12" }, 
            React.createElement('div', { key: taxAmount + totalWithTax, className: "absolute bottom-8 left-0 right-0 text-sm text-cyan-400 flex justify-between px-2" },
              React.createElement('span', { className: "inline-block animate-pop-in" }, taxAmount),
              React.createElement('span', { className: "inline-block animate-pop-in" }, totalWithTax)
            ),
            (aiSuggestion || error) && (
              React.createElement('div', { className: "absolute bottom-0 left-0 right-0 text-center text-sm text-[#ff3d00] bg-[rgba(255,61,0,0.15)] p-2 rounded-xl border border-[rgba(255,61,0,0.7)] z-10 flex justify-between items-center" },
                aiSuggestion?.isLoading ? (
                  React.createElement('span', { className: "flex-grow text-right px-2 animate-pulse" }, 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≠ŸÑ ÿ∞ŸÉŸä...')
                ) : (
                  React.createElement(React.Fragment, null,
                    React.createElement('span', { className: "flex-grow text-right px-2" },
                      aiSuggestion?.message || error?.message
                    ),
                    aiSuggestion?.fix && (
                        React.createElement('button', { onClick: onApplyAiFix, className: "bg-none border-none text-sky-500 dark:text-[#4fc3f7] font-bold cursor-pointer mr-1 whitespace-nowrap" }, "[‚ú® ÿ™ÿµÿ≠Ÿäÿ≠ ÿ¢ŸÑŸä]")
                    )
                  )
                )
              )
            )
          )
        )
      );
    };


    // --- Inlined: components/ButtonGrid.tsx ---
    const ButtonGrid = ({ onAppend, onClear, onBackspace, onCalculate, onToggleSign, onParenthesis, onToggleHistory, onAppendAnswer, layout }) => {
      return (
        React.createElement('div', { className: "grid grid-cols-5 gap-3" },
          layout.map((btn) => {
            const handleClick = () => {
              if (btn.action === 'clear') onClear();
              else if (btn.action === 'backspace') onBackspace();
              else if (btn.action === 'calculate') onCalculate();
              else if (btn.action === 'toggleSign') onToggleSign();
              else if (btn.action === 'parenthesis') onParenthesis();
              else if (btn.action === 'toggleHistory') onToggleHistory();
              else if (btn.action === 'appendAnswer') onAppendAnswer();
              else if (btn.value) onAppend(btn.value);
            };
            let style = {};
            let className = '';
            if (btn.type === 'number') {
                style.background = 'var(--button-number-bg)';
                style.color = 'var(--button-text-color-custom, var(--text-primary))';
            }
            if (btn.type === 'operator' || btn.type === 'function') {
                style.background = 'var(--button-function-bg)';
                style.color = 'var(--button-text-color-custom, var(--accent-color))';
            }
            if (btn.type === 'history') {
                style.background = 'var(--button-function-bg)';
                style.color = 'var(--text-secondary)';
                className += ' !text-base';
            }
            if (btn.type === 'equals') {
                style.background = 'var(--accent-equals-bg)';
                style.color = 'var(--accent-equals-text)';
                className += ' animate-pulse-special';
            }
            if (btn.span === 2) className += ' col-span-2';

            return (
              React.createElement(Button, {
                key: btn.id,
                onClick: handleClick,
                className: className,
                style: style,
              },
                btn.label
              )
            );
          })
        )
      );
    };


    // --- Inlined: components/Calculator.tsx ---
    const Calculator = ({ calculator, onToggleSettings, onToggleHistory, onShare, entryCount }) => {
      const { taxSettings } = calculator.settings;
      const { input, error, aiSuggestion, actions } = calculator;
      
      const handleShare = async () => {
        const expression = calculator.isCalculationExecuted ? calculator.history[0]?.expression : input;
        let resultText = '...';
        if (calculator.isCalculationExecuted) {
            resultText = input;
        } else {
            try {
                const safeExpr = input.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/%/g, '/100');
                const liveResult = parseExpression(safeExpr);
                if (!isNaN(liveResult) && isFinite(liveResult)) {
                    resultText = liveResult.toLocaleString('en-US', {maximumFractionDigits: 10, useGrouping: false});
                }
            } catch (e) { /* keep '...' if live parsing fails */ }
        }

        const textToShare = `ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®Ÿäÿ©:\n${expression}\n\nÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©:\n${resultText}`;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'ŸÜÿ™Ÿäÿ¨ÿ© ŸÖŸÜ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿ∞ŸÉŸäÿ©',
                    text: textToShare,
                });
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error sharing:', error);
                    navigator.clipboard.writeText(textToShare);
                    onShare('ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©ÿå ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!');
                }
            }
        } else {
            navigator.clipboard.writeText(textToShare);
            onShare('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!');
        }
      };
      return (
        React.createElement('div', { className: "relative max-w-md w-full z-10 animate-container-in" },
          React.createElement('div', { 
              className: "bg-[var(--bg-calculator)] rounded-[28px] p-4 w-full relative backdrop-blur-xl z-10 border border-[var(--border-primary)]",
              style: { boxShadow: 'var(--calculator-shadow, none)' }
            },
            React.createElement(Header, {
              taxSettings: taxSettings,
              onToggleSettings: onToggleSettings,
              onShare: handleShare,
              onToggleHistory: onToggleHistory,
              historyCount: calculator.history.length,
              entryCountDisplay: entryCount
            }),
            React.createElement(Display, {
              input: input,
              taxSettings: taxSettings,
              error: error,
              aiSuggestion: aiSuggestion,
              onApplyAiFix: actions.applyAiFix,
              isCalculationExecuted: calculator.isCalculationExecuted,
              onUpdateInput: actions.updateInput,
            }),
            React.createElement(ButtonGrid, {
              onAppend: actions.append,
              onClear: actions.clearAll,
              onBackspace: actions.backspace,
              onCalculate: actions.calculate,
              onToggleSign: actions.toggleSign,
              onParenthesis: actions.handleParenthesis,
              onToggleHistory: onToggleHistory,
              onAppendAnswer: actions.appendAnswer,
              layout: calculator.settings.buttonLayout,
            })
          )
        )
      );
    };


    // --- Inlined: components/SettingsPanel.tsx ---
    const convertArabicNumerals = (str) => {
        if (typeof str !== 'string' && typeof str !== 'number') return '';
        return String(str)
            .replace(/[Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©]/g, d => d.charCodeAt(0) - 1632)
            .replace(/[€∞€±€≤€≥€¥€µ€∂€∑€∏€π]/g, d => d.charCodeAt(0) - 1776);
    };
    const SettingsPanel = ({ isOpen, onClose, settings, theme, onThemeChange, fontFamily, setFontFamily, fontScale, setFontScale, buttonTextColor, setButtonTextColor, onOpenSupport, onShowAbout, onCheckForUpdates }) => {
      const { vibrationEnabled, setVibrationEnabled, taxSettings, setTaxSettings, maxHistory, setMaxHistory } = settings;
      
      const handleTaxChange = (e) => {
        const { name, value, type, checked } = e.target;
        setTaxSettings(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value
        }));
      };
      
      const handleTaxRateChange = (e) => {
         const westernValue = convertArabicNumerals(e.target.value);
         if (/^\d*\.?\d*$/.test(westernValue)) {
            setTaxSettings(prev => ({...prev, rate: westernValue }));
         }
      };

      return (
        React.createElement('div', { className: `fixed top-0 bottom-0 right-0 w-[320px] max-w-[85vw] bg-[var(--bg-panel)] text-[var(--text-primary)] z-50 p-5 shadow-2xl overflow-y-auto border-l-2 border-[var(--border-primary)] transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] transform ${isOpen ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0 pointer-events-none'}` },
          React.createElement('div', { className: "flex justify-between items-center mb-6" },
            React.createElement('h3', { className: "text-[var(--accent-color)] text-2xl font-bold" }, "‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™"),
            React.createElement('button', { onClick: onClose, className: "text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" }, "‚úï")
          ),
          React.createElement('div', { className: "mb-6" },
            React.createElement('h4', { className: "text-lg font-semibold text-[var(--text-secondary)] mb-3" }, "üé® ÿßŸÑŸÖÿ∏Ÿáÿ±"),
            React.createElement('div', { className: "grid grid-cols-3 gap-2 p-1 rounded-xl bg-[var(--bg-inset)]" },
              React.createElement('button', { onClick: () => onThemeChange('light'), className: `py-2 rounded-lg text-sm transition-all ${theme === 'light' ? 'bg-[var(--accent-color)] text-[var(--accent-color-contrast)] font-bold' : ''}` }, "ŸÅÿßÿ™ÿ≠"),
              React.createElement('button', { onClick: () => onThemeChange('dark'), className: `py-2 rounded-lg text-sm transition-all ${theme === 'dark' ? 'bg-[var(--accent-color)] text-[var(--accent-color-contrast)] font-bold' : ''}` }, "ÿØÿßŸÉŸÜ"),
              React.createElement('button', { onClick: () => onThemeChange('system'), className: `py-2 rounded-lg text-sm transition-all ${theme === 'system' ? 'bg-[var(--accent-color)] text-[var(--accent-color-contrast)] font-bold' : ''}` }, "ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ∏ÿßŸÖ")
            )
          ),
          React.createElement('div', { className: "mb-6" },
            React.createElement('h4', { className: "text-lg font-semibold text-[var(--text-secondary)] mb-3" }, "‚úíÔ∏è ÿßŸÑÿÆÿ∑Ÿàÿ∑"),
            React.createElement('div', { className: "mb-4" },
                React.createElement('label', { htmlFor: "font-family-select", className: "block text-[var(--text-secondary)] mb-2 text-sm" }, "ŸÜŸàÿπ ÿßŸÑÿÆÿ∑:"),
                React.createElement('select', { id: "font-family-select", value: fontFamily, onChange: e => setFontFamily(e.target.value), className: "w-full p-2.5 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] text-base" },
                    React.createElement('option', { value: 'Tajawal' }, 'Tajawal (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä)'),
                    React.createElement('option', { value: 'Cairo' }, 'Cairo'),
                    React.createElement('option', { value: 'Almarai' }, 'Almarai')
                )
            ),
            React.createElement('div', { className: "mb-4" },
                React.createElement('label', { htmlFor: "font-size-slider", className: "block text-[var(--text-secondary)] mb-2 text-sm" }, `ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑: (${Math.round(fontScale * 100)}%)`),
                React.createElement('input', { id: "font-size-slider", type: 'range', min: '0.85', max: '1.15', step: '0.05', value: fontScale, onChange: e => setFontScale(parseFloat(e.target.value)), className: 'w-full h-2 bg-[var(--bg-inset)] rounded-lg appearance-none cursor-pointer accent-[var(--accent-color)]' })
            ),
            React.createElement('div', { className: "mt-4" },
                React.createElement('label', { htmlFor: "button-text-color-picker", className: "flex justify-between items-center text-[var(--text-secondary)] text-sm mb-2" },
                    React.createElement('span', null, "ŸÑŸàŸÜ ÿÆÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±:"),
                    React.createElement('button', { onClick: () => setButtonTextColor(null), className: `text-xs text-[var(--accent-color)] hover:underline ${!buttonTextColor ? 'opacity-50 cursor-not-allowed' : ''}`, disabled: !buttonTextColor }, "ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ")
                ),
                React.createElement('div', { className: "relative" },
                    React.createElement('input', { id: "button-text-color-picker", type: "color", value: buttonTextColor || '#ffffff', onChange: e => setButtonTextColor(e.target.value), className: "w-full h-10 p-1 rounded-lg border border-[var(--border-secondary)] bg-[var(--bg-inset)] cursor-pointer" })
                )
            )
          ),
          React.createElement('hr', { className: "border-[var(--border-secondary)] my-4" }),
          React.createElement('div', { className: "mb-6" },
            React.createElement('h4', { className: "text-lg font-semibold text-[var(--text-secondary)] mb-3" }, "üí∞ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©"),
            React.createElement('label', { className: "flex items-center mb-4 text-[var(--text-secondary)] font-bold" },
              React.createElement('input', { type: "checkbox", name: "isEnabled", checked: taxSettings.isEnabled, onChange: handleTaxChange, className: "ml-3 w-5 h-5 accent-[var(--accent-color)]" }),
              "ÿ™ŸÅÿπŸäŸÑ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©"
            ),
            React.createElement('div', { className: `transition-opacity ${taxSettings.isEnabled ? 'opacity-100' : 'opacity-50 pointer-events-none'}`},
                React.createElement('label', { className: `flex items-center mb-4 text-[var(--text-secondary)]` },
                    React.createElement('input', { type: "checkbox", name: "showTaxPerNumber", checked: taxSettings.showTaxPerNumber, onChange: handleTaxChange, disabled: !taxSettings.isEnabled, className: "ml-3 w-5 h-5 accent-[var(--accent-color)]" }),
                    "ÿπÿ±ÿ∂ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© ŸÅŸàŸÇ ŸÉŸÑ ÿ±ŸÇŸÖ"
                ),
                React.createElement('select', { name: "mode", value: taxSettings.mode, onChange: handleTaxChange, className: "w-full p-2.5 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] mb-4 text-base" },
                  React.createElement('option', { value: "add-15" }, "ÿ•ÿ∂ÿßŸÅÿ© 15%"),
                  React.createElement('option', { value: "extract-custom" }, "ÿßÿ≥ÿ™ÿÆŸÑÿßÿµ ŸÜÿ≥ÿ®ÿ© ŸÖÿÆÿµÿµÿ©"),
                  React.createElement('option', { value: "divide-93" }, "ÿßŸÑŸÇÿ≥ŸÖÿ© ÿπŸÑŸâ 0.93"),
                  React.createElement('option', { value: "custom" }, "ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿ≥ÿ®ÿ© ŸÖÿÆÿµÿµÿ©")
                ),
                ['custom', 'extract-custom'].includes(taxSettings.mode) && (
                  React.createElement('div', { className: "flex items-center justify-between mb-4 animate-fade-in-down" },
                    React.createElement('label', { className: "text-[var(--text-secondary)]" }, "ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ©:"),
                    React.createElement('input', { 
                        type: "text", 
                        inputMode: "decimal",
                        value: taxSettings.rate, 
                        onChange: handleTaxRateChange, 
                        onBlur: () => setTaxSettings(prev => ({...prev, rate: parseFloat(prev.rate) || 0 })),
                        placeholder: "%", 
                        className: "w-24 p-2.5 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] text-base text-center direction-ltr" 
                    })
                  )
                )
            )
          ),
           React.createElement('div', { className: "mb-6" },
            React.createElement('h4', { className: "text-lg font-semibold text-[var(--text-secondary)] mb-3" }, "‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ÿπÿßŸÖÿ©"),
            React.createElement('label', { className: "flex items-center justify-between text-[var(--text-secondary)] mb-4" },
              React.createElement('span', null, "ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ≥ÿ¨ŸÑ:"),
              React.createElement('input', { type: "number", value: maxHistory, onChange: (e) => {
                  const val = parseInt(e.target.value, 10);
                  if (val > 0 && val <= 500) {
                    setMaxHistory(val);
                  }
                }, min: "1", max: "500", className: "w-24 p-2 rounded-lg border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] text-center"
              })
            ),
            React.createElement('label', { className: "flex items-center justify-between text-[var(--text-secondary)]" },
              React.createElement('span', null, "ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑"),
              React.createElement('input', { type: "checkbox", checked: vibrationEnabled, onChange: (e) => setVibrationEnabled(e.target.checked), className: "w-5 h-5 accent-[var(--accent-color)]" })
            )
          ),
          React.createElement('hr', { className: "border-[var(--border-secondary)] my-4" }),
          React.createElement('div', { className: "flex flex-col gap-3" },
            React.createElement('button', { onClick: onCheckForUpdates, className: "w-full py-3 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] font-bold text-base hover:brightness-95" }, "‚ú® ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™"),
            React.createElement('button', { onClick: onShowAbout, className: "w-full py-3 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] font-bold text-base hover:brightness-95" }, "‚ÑπÔ∏è ÿ≠ŸàŸÑ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©"),
            React.createElement('button', { onClick: onOpenSupport, className: "w-full bg-gradient-to-br from-green-600/50 to-green-700/60 text-white border border-green-400/80 rounded-xl py-3 font-bold text-lg shadow-[0_5px_12px_rgba(0,0,0,0.35),0_0_18px_rgba(100,220,100,0.35)] mt-3 hover:from-green-600/60" }, "üí¨ ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ")
          )
        )
      );
    };


    // --- Inlined: components/HistoryPanel.tsx ---
    const HistoryPanel = ({ isOpen, onClose, history, onClearHistory, onHistoryItemClick, onExportHistory, onExportCsvHistory, onUpdateHistoryItemNote, onDeleteItem }) => {
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [searchTerm, setSearchTerm] = useState('');
      const [editingItem, setEditingItem] = useState(null); // { id: number, note: string }

      const handleExport = (exportFunc) => {
        exportFunc(startDate, endDate);
      };

      const clearDates = () => {
        setStartDate('');
        setEndDate('');
      };

      const handleEditSave = () => {
        if (!editingItem) return;
        onUpdateHistoryItemNote(editingItem.id, editingItem.note);
        setEditingItem(null);
      };

      const filteredHistory = useMemo(() => {
        return history.filter(item => {
          if (!searchTerm) return true;
          const searchLower = searchTerm.toLowerCase();
          const expressionMatch = item.expression.toLowerCase().includes(searchLower);
          const resultMatch = item.result.toLowerCase().includes(searchLower);
          const notesMatch = item.notes && item.notes.toLowerCase().includes(searchLower);
          return expressionMatch || resultMatch || notesMatch;
        });
      }, [history, searchTerm]);

      return (
        React.createElement('div', { className: `fixed top-0 bottom-0 left-0 w-[320px] max-w-[85vw] bg-[var(--bg-panel)] text-[var(--text-primary)] z-50 p-5 shadow-2xl overflow-y-auto border-r-2 border-[var(--border-primary)] transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] transform ${isOpen ? 'translate-x-0 opacity-100' : '-translate-x-full opacity-0 pointer-events-none'}` },
          React.createElement('div', { className: "flex justify-between items-center mb-4" },
            React.createElement('h3', { className: "text-[var(--accent-color)] text-2xl font-bold" }, `üìú ÿßŸÑÿ≥ÿ¨ŸÑ (${history.length})`),
            React.createElement('button', { onClick: onClose, className: "text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" }, "‚úï")
          ),
          React.createElement('div', { className: "mb-4" },
             React.createElement('input', { type: "search", placeholder: "ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ...", value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: "w-full p-2.5 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] text-base" })
          ),
          React.createElement('div', { className: "text-center mb-4 flex justify-center gap-2" },
            React.createElement('button', { onClick: onClearHistory, className: "py-1 px-3 text-sm rounded-lg bg-[var(--bg-inset)] text-[var(--accent-color)] hover:brightness-95 transition-colors" }, "ŸÖÿ≥ÿ≠"),
            React.createElement('button', { onClick: () => handleExport(onExportHistory), className: "py-1 px-3 text-sm rounded-lg bg-[var(--bg-inset)] text-sky-400 hover:brightness-95 transition-colors" }, "TXT"),
            React.createElement('button', { onClick: () => handleExport(onExportCsvHistory), className: "py-1 px-3 text-sm rounded-lg bg-[var(--bg-inset)] text-green-400 hover:brightness-95 transition-colors" }, "CSV")
          ),
          React.createElement('div', { className: "flex flex-col gap-2" },
            filteredHistory.length === 0 ? (
              React.createElement('p', { className: "text-center text-[var(--text-secondary)] text-base mt-8" }, "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨.")
            ) : (
              filteredHistory.map((item) => {
                const isEditing = editingItem && editingItem.id === item.id;
                return (
                  React.createElement('div', { key: item.id, className: "p-4 bg-[var(--bg-inset-light)] rounded-xl transition-all duration-200" },
                    React.createElement('div', { onClick: () => !isEditing && onHistoryItemClick(item), className: "cursor-pointer" },
                        React.createElement('div', { className: "text-base opacity-80 direction-ltr text-left break-all text-[var(--text-secondary)]" }, item.expression, " ="),
                        React.createElement('div', { className: "text-2xl font-bold direction-ltr text-left break-all" }, item.result),
                        item.taxResult && (
                            React.createElement('div', { className: "text-cyan-400 text-base mt-2" }, `${item.taxLabel || 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©'}: `, item.taxResult)
                        ),
                        React.createElement('div', { className: "text-[var(--text-secondary)] opacity-70 text-xs mt-1" }, item.date, " - ", item.time)
                    ),
                    isEditing ? (
                        React.createElement('div', { className: "mt-3 animate-fade-in-down" },
                            React.createElement('textarea', {
                                value: editingItem.note,
                                onChange: (e) => setEditingItem(prev => ({...prev, note: e.target.value})),
                                className: "w-full p-2 rounded-lg border border-[var(--border-secondary)] bg-[var(--bg-inset)] text-[var(--text-primary)] text-sm",
                                placeholder: "ÿ£ÿ∂ŸÅ ŸÖŸÑÿßÿ≠ÿ∏ÿ©...",
                                rows: 2
                            }),
                            React.createElement('div', { className: "flex gap-2 mt-2" },
                                React.createElement('button', { onClick: handleEditSave, className: "flex-1 py-1 text-sm rounded-lg bg-green-500/80 text-white" }, "ÿ≠ŸÅÿ∏"),
                                React.createElement('button', { onClick: () => setEditingItem(null), className: "flex-1 py-1 text-sm rounded-lg bg-[var(--bg-inset)]" }, "ÿ•ŸÑÿ∫ÿßÿ°")
                            )
                        )
                    ) : (
                        React.createElement('div', { className: "mt-2 flex justify-between items-center" },
                            item.notes ?
                                React.createElement('p', { className: "text-sm text-[var(--text-secondary)] italic pr-2 break-all flex-grow" }, `"${item.notes}"`) :
                                React.createElement('div', { className: "flex-grow" }),
                             React.createElement('div', { className: "flex items-center gap-2 flex-shrink-0" },
                                React.createElement('button', { onClick: () => setEditingItem({ id: item.id, note: item.notes || '' }), className: "text-xs text-[var(--accent-color)] hover:underline whitespace-nowrap" }, item.notes ? "ÿ™ÿπÿØŸäŸÑ" : "ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ©"),
                                React.createElement('button', {
                                    onClick: () => onDeleteItem(item),
                                    'aria-label': `ÿ≠ÿ∞ŸÅ ${item.expression}`,
                                    className: "text-lg text-red-500/70 hover:text-red-500 transition-colors"
                                }, "üóëÔ∏è")
                             )
                        )
                    )
                  )
                )
              })
            )
          )
        )
      );
    };


    // --- Inlined: components/SupportPanel.tsx ---
    const sendSupportMessage = () => {
        const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSd3Wx_1HGEUGRRqUP411cn_hQyR6lxvxw18F2Tb5rC-NPwiGw/viewform';
        window.open(formUrl, '_blank');
    };
    const SupportPanel = ({ isOpen, onClose }) => {
      return (
        React.createElement('div', { className: `fixed top-0 bottom-0 left-0 w-[320px] max-w-[85vw] bg-[var(--bg-panel)] text-[var(--text-primary)] z-50 p-5 shadow-2xl overflow-y-auto transition-transform duration-300 ease-in-out border-r-2 border-[var(--border-primary)] transform ${isOpen ? 'translate-x-0' : '-translate-x-full'}` },
          React.createElement('div', { className: "flex justify-between items-center mb-6" },
            React.createElement('h2', { className: "text-[var(--accent-color)] text-2xl font-bold" }, "üí¨ ÿØÿπŸÖ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©"),
            React.createElement('button', { onClick: onClose, className: "text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" }, "‚úï")
          ),
          React.createElement('div', { className: "bg-[var(--bg-inset-light)] rounded-2xl p-4 mb-6 border border-[var(--border-secondary)]" },
            React.createElement('p', { className: "text-[var(--text-secondary)] leading-relaxed text-base" },
                "ŸÖÿ±ÿ≠ÿ®Ÿãÿß! üëã ŸÜÿ≠ŸÜ ŸÖÿ™ÿ≠ŸÖÿ≥ŸàŸÜ ŸÑÿ≥ŸÖÿßÿπ ÿ±ÿ£ŸäŸÉ. ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿ©ÿå ÿßŸÇÿ™ÿ±ÿßÿ≠ÿå ÿ£Ÿà ÿ®ŸÑÿßÿ∫ ÿπŸÜ ŸÖÿ¥ŸÉŸÑÿ©.",
                React.createElement('br'), React.createElement('br'),
                React.createElement('span', { className: "text-[var(--accent-color)] font-bold" }, "‚úì ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ ÿØÿπŸÖ ÿ±ÿ≥ŸÖŸä ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ™ŸÉ!")
            )
          ),
          React.createElement('button', { onClick: () => { sendSupportMessage(); onClose(); }, className: "w-full bg-gradient-to-br from-green-600/80 to-green-700/90 text-white border border-green-400/80 rounded-2xl p-4 text-lg font-bold cursor-pointer shadow-[0_7px_16px_rgba(0,0,0,0.35),0_0_22px_rgba(100,220,100,0.35)] hover:from-green-600" },
            "ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿØÿπŸÖ ÿßŸÑÿ¢ŸÜ"
          )
        )
      );
    };


    // --- Inlined: components/AboutPanel.tsx ---
    const AboutPanel = ({ isOpen, onClose }) => {
      return (
        React.createElement('div', { className: `fixed top-0 bottom-0 right-0 w-[320px] max-w-[85vw] bg-[var(--bg-panel)] text-[var(--text-primary)] z-50 p-5 shadow-2xl overflow-y-auto transition-transform duration-300 ease-in-out border-l-2 border-[var(--border-primary)] transform ${isOpen ? 'translate-x-0' : 'translate-x-full'}` },
          React.createElement('div', { className: "flex justify-between items-center mb-6" },
            React.createElement('h2', { className: "text-[var(--accent-color)] text-2xl font-bold" }, "‚ÑπÔ∏è ÿ≠ŸàŸÑ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©"),
            React.createElement('button', { onClick: onClose, className: "text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" }, "‚úï")
          ),
          React.createElement('div', { className: "bg-[var(--bg-inset-light)] rounded-2xl p-4 mb-6 border border-[var(--border-secondary)]" },
              React.createElement('p', { className: "text-[var(--text-secondary)] leading-relaxed text-base font-semibold text-center mb-4" }, "ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ŸÖÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™!"),
              React.createElement('p', { className: "text-[var(--text-secondary)] leading-relaxed text-base mb-4" }, "Ÿáÿ∞Ÿá ŸÑŸäÿ≥ÿ™ ŸÖÿ¨ÿ±ÿØ ÿ¢ŸÑÿ© ÿ≠ÿßÿ≥ÿ®ÿ©ÿå ÿ®ŸÑ ŸáŸä ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿµŸÖŸÖ ŸÑÿ¨ÿπŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ™ÿπŸÖŸÑ ŸÖŸÜ ÿ£ÿ¨ŸÑŸÉ."),
              React.createElement('h4', { className: "text-[var(--text-primary)] font-bold mb-2" }, "ÿ£ÿ®ÿ±ÿ≤ ÿßŸÑŸÖŸäÿ≤ÿßÿ™:"),
              React.createElement('ul', { className: 'list-disc list-inside space-y-2 text-[var(--text-secondary)]' },
                  React.createElement('li', null, React.createElement('strong', { className: "text-[var(--text-primary)]" }, "üß† ÿ™ÿµÿ≠Ÿäÿ≠ ÿ∞ŸÉŸä:"), " ŸÖÿØÿπŸàŸÖÿ© ŸÖŸÜ Gemini AIÿå ÿ™ŸÇŸàŸÖ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° Ÿàÿ™ŸÇÿØŸäŸÖ ÿ•ÿµŸÑÿßÿ≠ÿßÿ™ ŸÅŸàÿ±Ÿäÿ©."),
                  React.createElement('li', null, React.createElement('strong', { className: "text-[var(--text-primary)]" }, "üí∞ ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ∂ÿ±Ÿäÿ®Ÿäÿ© ŸÖÿ™ŸÇÿØŸÖÿ©:"), " ÿ£Ÿàÿ∂ÿßÿπ ÿ∂ÿ±Ÿäÿ®Ÿäÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿÆÿµŸäÿµ ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿå ÿ≥Ÿàÿßÿ° ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ∂ÿ±Ÿäÿ®ÿ© ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ÿ£Ÿà ÿßÿ≥ÿ™ÿÆŸÑÿßÿµŸáÿß."),
                  React.createElement('li', null, React.createElement('strong', { className: "text-[var(--text-primary)]" }, "üìú ÿ≥ÿ¨ŸÑ ÿ¥ÿßŸÖŸÑ:"), " ŸÑÿß ÿ™ŸÅŸÇÿØ ÿ£Ÿä ÿπŸÖŸÑŸäÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ. ÿ£ÿ∂ŸÅ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ÿå ŸàÿµÿØŸëÿ± ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÉŸÖŸÑŸÅÿßÿ™ TXT ÿ£Ÿà CSV."),
                  React.createElement('li', null, React.createElement('strong', { className: "text-[var(--text-primary)]" }, "üé® ÿ™ÿÆÿµŸäÿµ ÿπŸÖŸäŸÇ:"), " ÿßÿÆÿ™ÿ± ÿ®ŸäŸÜ ÿßŸÑŸÖÿ∏ÿßŸáÿ±ÿå ÿ∫ŸäŸëÿ± ÿßŸÑÿÆÿ∑Ÿàÿ∑ÿå Ÿàÿ≠ÿ™Ÿâ ŸÑŸàŸÜ ŸÜÿµ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±."),
                  React.createElement('li', null, React.createElement('strong', { className: "text-[var(--text-primary)]" }, "üåê ÿ™ÿ∑ÿ®ŸäŸÇ ŸàŸäÿ® ÿ™ŸÇÿØŸÖŸä (PWA):"), " ÿ´ÿ®Ÿëÿ™ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ© ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ Ÿàÿßÿ≥ÿ™ÿÆÿØŸÖŸáÿß ÿ®ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.")
              )
          ),
          React.createElement('div', { className: "text-center text-sm text-gray-400 dark:text-gray-500" },
            "ÿßŸÑÿ•ÿµÿØÿßÿ± 1.6.0 ¬© 2025"
          )
        )
      );
    };


    // --- Inlined: components/ConfirmationDialog.tsx ---
    const ConfirmationDialog = ({ isOpen, onConfirm, onCancel, title, message }) => {
      return React.createElement('div', {},
        isOpen && React.createElement(React.Fragment, null,
          React.createElement(Overlay, { show: isOpen, onClick: onCancel, zIndex: 'z-50' }),
          React.createElement('div', {
            className: `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[340px] max-w-[90vw] bg-[var(--bg-panel)] text-[var(--text-primary)] z-[60] p-6 rounded-3xl shadow-2xl border border-[var(--border-primary)] transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] animate-bounce-in-up`,
            role: "alertdialog",
            "aria-modal": "true",
            "aria-labelledby": "dialog-title",
            "aria-describedby": "dialog-message"
          },
            React.createElement('h3', { id: "dialog-title", className: "text-[var(--accent-color)] text-2xl font-bold mb-4" }, title),
            React.createElement('p', { id: "dialog-message", className: "text-[var(--text-secondary)] mb-6 text-base leading-relaxed break-words" }, message),
            React.createElement('div', { className: "flex justify-end gap-3" },
              React.createElement('button', {
                onClick: onCancel,
                className: "py-2 px-6 rounded-xl bg-[var(--bg-inset)] text-[var(--text-secondary)] font-bold hover:brightness-95 transition-colors"
              }, "ÿ•ŸÑÿ∫ÿßÿ°"),
              React.createElement('button', {
                onClick: onConfirm,
                className: "py-2 px-6 rounded-xl bg-red-600 text-white font-bold shadow-lg hover:bg-red-700 transition-colors"
              }, "ÿ™ÿ£ŸÉŸäÿØ")
            )
          )
        )
      );
    };


    // --- Inlined: App.tsx ---
    function App() {
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [isHistoryOpen, setIsHistoryOpen] = useState(false);
      const [isSupportOpen, setIsSupportOpen] = useState(false);
      const [isAboutOpen, setIsAboutOpen] = useState(false);
      const [notification, setNotification] = useState({ message: '', show: false });
      const [appUpdate, setAppUpdate] = useState({ available: false, registration: null });
      const [confirmation, setConfirmation] = useState({ isOpen: false, onConfirm: null, onCancel: null, title: '', message: '' });

      const [theme, setTheme] = useLocalStorage('calcTheme_v3', 'system');
      const [fontFamily, setFontFamily] = useLocalStorage('calcFontFamily_v2', 'Tajawal');
      const [fontScale, setFontScale] = useLocalStorage('calcFontScale_v2', 1);
      const [buttonTextColor, setButtonTextColor] = useLocalStorage('calcButtonTextColor_v1', null);


      const showNotification = useCallback((message) => {
        setNotification({ message, show: true });
        setTimeout(() => {
          setNotification({ message: '', show: false });
        }, 2500);
      }, []);
      
      const calculator = useCalculator({ showNotification });

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('history') === 'true') {
            setIsHistoryOpen(true);
            // Clean up the URL so it doesn't stay there on refresh
            window.history.replaceState({}, document.title, window.location.pathname);
        }
      }, []);
      
      useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = () => {
            if (theme === 'system') {
                document.documentElement.classList.toggle('dark', mediaQuery.matches);
                document.querySelector('meta[name="theme-color"]').setAttribute('content', mediaQuery.matches ? '#0a0e17' : '#FFFFFF');
            }
        };

        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0a0e17');
        } else if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#FFFFFF');
        } else { // system
            handleChange(); // set initial system theme
        }

        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
      }, [theme]);

      useEffect(() => {
          document.documentElement.style.setProperty('--font-family', fontFamily);
          document.documentElement.style.setProperty('--font-scale', fontScale);
      }, [fontFamily, fontScale]);

      useEffect(() => {
        if (buttonTextColor) {
            document.documentElement.style.setProperty('--button-text-color-custom', buttonTextColor);
        } else {
            document.documentElement.style.removeProperty('--button-text-color-custom');
        }
      }, [buttonTextColor]);

       useEffect(() => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                setAppUpdate(prev => ({...prev, registration}));
                registration.onupdatefound = () => {
                    const installingWorker = registration.installing;
                    if (installingWorker) {
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    setAppUpdate({ available: true, registration });
                                }
                            }
                        };
                    }
                };
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }
    }, []);
      
      const closeAllPanels = useCallback(() => {
        setIsSettingsOpen(false);
        setIsHistoryOpen(false);
        setIsSupportOpen(false);
        setIsAboutOpen(false);
      }, []);

      const handleClearHistory = useCallback(() => {
        if (calculator.history.length === 0) {
            showNotification("ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅÿßÿ±ÿ∫ ÿ®ÿßŸÑŸÅÿπŸÑ.");
            return;
        }
        setConfirmation({
            isOpen: true,
            title: 'ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™',
            message: 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.',
            onConfirm: () => {
                calculator.actions.clearHistory();
                setConfirmation({ isOpen: false });
                showNotification("ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠.");
            },
            onCancel: () => {
                setConfirmation({ isOpen: false });
            }
        });
      }, [calculator.history, calculator.actions.clearHistory, showNotification]);
      
      const handleDeleteHistoryItem = useCallback((item) => {
        setConfirmation({
            isOpen: true,
            title: 'ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ©',
            message: `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ©: "${item.expression} = ${item.result}"ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.`,
            onConfirm: () => {
                calculator.actions.deleteHistoryItem(item.id);
                setConfirmation({ isOpen: false });
                showNotification("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠.");
            },
            onCancel: () => {
                setConfirmation({ isOpen: false });
            }
        });
      }, [calculator.actions.deleteHistoryItem, showNotification]);

      const onCheckForUpdates = useCallback(() => {
        if (appUpdate.registration) {
            appUpdate.registration.update().then(reg => {
                if (reg.installing || reg.waiting) {
                    showNotification("ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ÿ≠ÿØŸäÿ´! ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©.");
                    setAppUpdate({ available: true, registration: reg });
                } else {
                    showNotification("ÿ£ŸÜÿ™ ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿ£ÿ≠ÿØÿ´ ÿ•ÿµÿØÿßÿ±.");
                }
            }).catch(() => {
                showNotification("ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.");
            });
        } else {
            showNotification("ÿÆÿØŸÖÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©.");
        }
      }, [appUpdate.registration, showNotification]);

      const onUpdateAccepted = () => {
          if (appUpdate.registration && appUpdate.registration.waiting) {
              appUpdate.registration.waiting.postMessage({ type: 'SKIP_WAITING' });
              // The page will reload via the 'controllerchange' event listener
          }
      };
      
      const createExportContent = useCallback((history, format) => {
        const getTaxModeLabel = (mode, rate) => {
            if (!mode) return "ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©";
            switch (mode) {
                case 'add-15': return "ÿ•ÿ∂ÿßŸÅÿ© 15%";
                case 'divide-93': return "ÿßŸÑŸÇÿ≥ŸÖÿ© ÿπŸÑŸâ 0.93";
                case 'custom': return `ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿÆÿµÿµ ${rate}%`;
                case 'extract-custom': return `ÿßÿ≥ÿ™ÿÆŸÑÿßÿµ ŸÖÿÆÿµÿµ ${rate}%`;
                default: return "ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ";
            }
        };

        if (format === 'txt') {
            const header = "ÿ≥ÿ¨ŸÑ ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©\n\n";
            const content = history.map(item =>
                `ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${item.date} - ${item.time}\n` +
                `ÿßŸÑÿπŸÖŸÑŸäÿ©: ${item.expression}\n` +
                `ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${item.result}\n` +
                (item.taxResult ? `Ÿàÿ∂ÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©: ${getTaxModeLabel(item.taxMode, item.taxRate)}\n${item.taxLabel || 'ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ŸÖÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©'}: ${item.taxResult}\n` : '') +
                (item.notes ? `ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ${item.notes}\n` : '') +
                "------------------------------------\n"
            ).join('\n');
            return header + content;
        }

        if (format === 'csv') {
            const escapeCsvCell = (cell) => `"${String(cell ?? '').replace(/"/g, '""')}"`;
            const headers = ["ÿßŸÑÿ™ÿßÿ±ŸäÿÆ", "ÿßŸÑŸàŸÇÿ™", "ÿßŸÑÿπŸÖŸÑŸäÿ©", "ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©", "Ÿàÿ∂ÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©", "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©", "ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ© (ÿ∂ÿ±Ÿäÿ®ÿ©/ÿ£ÿµŸÑ)", "ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™"].map(escapeCsvCell).join(',');
            const rows = history.map(item => [
                item.date, item.time, item.expression, item.result,
                getTaxModeLabel(item.taxMode, item.taxRate), item.taxRate, item.taxResult, item.notes
            ].map(escapeCsvCell).join(',')).join('\n');
            return `\uFEFF${headers}\n${rows}`;
        }
        return '';
      }, []);

      const handleExport = useCallback((format, startDate, endDate) => {
          const filteredHistory = calculator.history.filter(item => {
            if (!startDate && !endDate) return true;
            const [d, m, y] = item.date.split('/');
            if (!d || !m || !y) return false;
            const itemDate = new Date(`${y}-${m}-${d}`);
            if (isNaN(itemDate.getTime())) return false;
            
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            
            if (start && itemDate < start) return false;
            if (end && itemDate > end) return false;
            return true;
        });

        if (filteredHistory.length === 0) {
            showNotification("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ± ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≤ŸÖŸÜŸä.");
            return;
        }

        const content = createExportContent(filteredHistory, format);
        const mimeType = format === 'csv' ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8';
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        link.download = `calculator-history-${timestamp}.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showNotification(`ÿ¨ÿßÿ±Ÿä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑ ŸÉŸÄ ${format.toUpperCase()}...`);
        closeAllPanels();
      }, [calculator.history, closeAllPanels, showNotification, createExportContent]);
      
      const anyPanelOpen = isSettingsOpen || isHistoryOpen || isSupportOpen || isAboutOpen;

      return (
        React.createElement('div', { className: "min-h-screen bg-cover bg-center bg-fixed", style: { background: 'var(--bg-primary-gradient)' } },
          React.createElement('div', { className: `flex justify-center items-center min-h-screen w-full font-sans relative pt-24 pb-8 md:pt-8` },
            appUpdate.available && (
               React.createElement('div', { className: "absolute top-4 z-20 w-[calc(100%-2rem)] max-w-[420px] bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-4 rounded-2xl shadow-lg flex items-center justify-between animate-fade-in-down" },
                 React.createElement('div', null,
                   React.createElement('h4', { className: "font-bold" }, `‚ú® ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸäÿØ ÿ¨ÿßŸáÿ≤!`),
                   React.createElement('p', { className: "text-sm opacity-90" }, "ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ´ÿ®Ÿäÿ™ Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©.")
                 ),
                 React.createElement('button', { onClick: onUpdateAccepted, className: "bg-white text-blue-600 font-bold py-1.5 px-3 rounded-lg text-sm hover:bg-gray-200 transition-colors" }, "ÿ™ÿ´ÿ®Ÿäÿ™")
               )
            ),
            React.createElement(Calculator, {
              calculator: calculator,
              onToggleSettings: () => setIsSettingsOpen(v => !v),
              onToggleHistory: () => setIsHistoryOpen(v => !v),
              onShare: showNotification,
              entryCount: calculator.entryCount
            })
          ),
          React.createElement(Overlay, { show: anyPanelOpen, onClick: closeAllPanels }),
          React.createElement(SettingsPanel, {
            isOpen: isSettingsOpen,
            onClose: closeAllPanels,
            settings: calculator.settings,
            theme: theme,
            onThemeChange: setTheme,
            fontFamily: fontFamily, 
            setFontFamily: setFontFamily,
            fontScale: fontScale,
            setFontScale: setFontScale,
            buttonTextColor: buttonTextColor,
            setButtonTextColor: setButtonTextColor,
            onOpenSupport: () => { closeAllPanels(); setIsSupportOpen(true); },
            onShowAbout: () => { closeAllPanels(); setIsAboutOpen(true); },
            onCheckForUpdates: onCheckForUpdates
          }),
          React.createElement(HistoryPanel, {
            isOpen: isHistoryOpen,
            onClose: closeAllPanels,
            history: calculator.history,
            onClearHistory: handleClearHistory,
            onHistoryItemClick: (item) => {
              calculator.actions.loadFromHistory(item.expression);
              closeAllPanels();
            },
            onExportHistory: (start, end) => handleExport('txt', start, end),
            onExportCsvHistory: (start, end) => handleExport('csv', start, end),
            onUpdateHistoryItemNote: calculator.actions.updateHistoryItemNote,
            onDeleteItem: handleDeleteHistoryItem
          }),
          React.createElement(SupportPanel, { isOpen: isSupportOpen, onClose: closeAllPanels }),
          React.createElement(AboutPanel, { isOpen: isAboutOpen, onClose: closeAllPanels }),
          React.createElement(ConfirmationDialog, {
            isOpen: confirmation.isOpen,
            title: confirmation.title,
            message: confirmation.message,
            onConfirm: confirmation.onConfirm,
            onCancel: confirmation.onCancel
          }),
          React.createElement(Notification, { message: notification.message, show: notification.show })
        )
      );
    }


    // --- Application Entry Point ---
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      React.createElement(React.StrictMode, null,
        React.createElement(App, null)
      )
    );
  </script>
  
  <script>
    // Register the Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>